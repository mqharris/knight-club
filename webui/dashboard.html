<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Knight Club - Dashboard</title>
  <style>
    body {
      font-family: sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      margin: 0;
      padding: 20px;
    }
    .navbar {
      background: white;
      padding: 15px 30px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
    }
    .navbar h1 {
      margin: 0;
      color: #333;
      font-size: 24px;
    }
    .navbar .user-info {
      display: flex;
      gap: 20px;
      align-items: center;
    }
    .navbar .username {
      color: #667eea;
      font-weight: 600;
    }
    .navbar button {
      padding: 8px 20px;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: 600;
    }
    .navbar button:hover {
      background: #5568d3;
    }
    .content {
      background: white;
      padding: 40px;
      border-radius: 10px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.2);
      max-width: 800px;
      margin: 0 auto;
    }
    .welcome {
      text-align: center;
      color: #333;
      margin-bottom: 30px;
    }
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-top: 30px;
    }
    .stat-card {
      background: #f5f7fa;
      padding: 20px;
      border-radius: 8px;
      text-align: center;
    }
    .stat-card h3 {
      margin: 0 0 10px 0;
      color: #667eea;
      font-size: 32px;
    }
    .stat-card p {
      margin: 0;
      color: #666;
    }
  </style>
</head>
<body>
  <div class="navbar">
    <h1>üõ°Ô∏è KNIGHT CLUB</h1>
    <div class="user-info">
      <span class="username" id="username"></span>
      <button onclick="logout()">Logout</button>
    </div>
  </div>

  <div class="content">
    <div class="welcome">
      <h2>Your Knights</h2>
    </div>

    <div id="knightsList"></div>

    <button id="createKnightBtn" onclick="showCreateForm()" style="margin-top: 20px; padding: 12px 30px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: 600; font-size: 16px;">
      Create New Knight
    </button>

    <div id="createFormContainer" style="display: none; margin-top: 30px; padding: 20px; background: #f5f7fa; border-radius: 8px;">
      <h3>Create a New Knight</h3>
      <form id="createKnightForm">
        <div style="margin-bottom: 15px;">
          <label style="display: block; margin-bottom: 5px; color: #555; font-weight: 600;">Name</label>
          <input type="text" id="knightName" required style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 5px; box-sizing: border-box;">
        </div>
        <div style="margin-bottom: 15px;">
          <label style="display: block; margin-bottom: 5px; color: #555; font-weight: 600;">Class</label>
          <select id="knightClass" required style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 5px; box-sizing: border-box;">
            <option value="knight">Knight</option>
            <option value="paladin">Paladin</option>
            <option value="lancer">Lancer</option>
            <option value="templar">Templar</option>
          </select>
        </div>
        <div style="display: flex; gap: 10px;">
          <button type="submit" style="flex: 1; padding: 12px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: 600;">Create</button>
          <button type="button" onclick="hideCreateForm()" style="flex: 1; padding: 12px; background: #ccc; color: #333; border: none; border-radius: 5px; cursor: pointer; font-weight: 600;">Cancel</button>
        </div>
      </form>
    </div>

    <!-- Leaderboard Section -->
    <div style="margin-top: 40px; padding: 20px; background: #f5f7fa; border-radius: 8px;">
      <h3 style="margin: 0 0 20px 0; color: #333; display: flex; align-items: center; gap: 10px;">
        üèÜ Leaderboard - Top 10 Knights
      </h3>
      <div id="leaderboard"></div>
    </div>

    <!-- Wanted Board Section -->
    <div style="margin-top: 40px; padding: 20px; background: #ffe6e6; border-radius: 8px; border: 3px solid #c0392b;">
      <h3 style="margin: 0 0 20px 0; color: #c0392b; display: flex; align-items: center; gap: 10px;">
        ‚ö†Ô∏è WANTED BOARD - MOST DANGEROUS
      </h3>
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
        <!-- Brent Card -->
        <div onclick="showWantedReason('Brent', 'Wanted for the ruthless murder of countless knights across the realm. Known to show no mercy in battle. Extremely dangerous - has left a trail of fallen warriors in his wake. Approach with extreme caution.')" 
             style="background: white; border: 3px solid #e74c3c; border-radius: 10px; padding: 20px; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; box-shadow: 0 4px 6px rgba(0,0,0,0.1);"
             onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 6px 12px rgba(0,0,0,0.2)';"
             onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 4px 6px rgba(0,0,0,0.1)';">
          <div style="text-align: center;">
            <div style="font-size: 60px; margin-bottom: 10px;">üßî</div>
            <h4 style="margin: 0; color: #c0392b; font-size: 24px;">BRENT</h4>
            <div style="background: #e74c3c; color: white; padding: 5px 10px; border-radius: 5px; margin-top: 10px; font-weight: bold;">
              REWARD: 50,000 GOLD
            </div>
            <div style="margin-top: 10px; color: #666; font-size: 14px;">
              Charges: Mass Knight Murder
            </div>
          </div>
        </div>

        <!-- Craig Card -->
        <div onclick="showWantedReason('Craig', 'Wanted for suspiciously rapid advancement through the ranks. Has been observed gaining levels at an impossible rate. Suspected of using forbidden dark magic or exploits. Investigation ongoing.')" 
             style="background: white; border: 3px solid #e74c3c; border-radius: 10px; padding: 20px; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; box-shadow: 0 4px 6px rgba(0,0,0,0.1);"
             onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 6px 12px rgba(0,0,0,0.2)';"
             onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 4px 6px rgba(0,0,0,0.1)';">
          <div style="text-align: center;">
            <div style="font-size: 60px; margin-bottom: 10px;">üßë</div>
            <h4 style="margin: 0; color: #c0392b; font-size: 24px;">CRAIG</h4>
            <div style="background: #e74c3c; color: white; padding: 5px 10px; border-radius: 5px; margin-top: 10px; font-weight: bold;">
              REWARD: 25,000 GOLD
            </div>
            <div style="margin-top: 10px; color: #666; font-size: 14px;">
              Charges: Suspicious Leveling
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="message" style="margin-top: 20px;"></div>
  </div>

  <script>
    // Check if user is logged in
    const user = JSON.parse(localStorage.getItem('knightclub_user') || 'null');
    if (!user) {
      window.location.href = '/';
    }

    // Display username
    document.getElementById('username').textContent = user.username;

    let knights = [];

    function logout() {
      localStorage.removeItem('knightclub_user');
      window.location.href = '/';
    }

    async function loadKnights() {
      try {
        const response = await fetch(`/api/knights?user_id=${user.user_id}`);
        const data = await response.json();
        
        if (response.ok) {
          knights = data.knights || [];
          displayKnights();
          updateCreateButton();
        }
      } catch (error) {
        showMessage('Error loading knights', 'error');
      }
    }

    function displayKnights() {
      const container = document.getElementById('knightsList');
      
      if (knights.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">No knights yet. Create your first knight!</p>';
        return;
      }

      container.innerHTML = knights.map(knight => {
        const isDead = !knight.is_alive;
        const greyStyle = isDead ? 'opacity: 0.5; filter: grayscale(100%);' : '';
        const statusBadge = isDead ? '<span style="background: #e74c3c; color: white; padding: 3px 8px; border-radius: 3px; font-size: 12px; font-weight: bold;">DECEASED</span>' : '';
        
        return `
        <div style="background: #f5f7fa; padding: 20px; border-radius: 8px; margin-bottom: 15px; cursor: pointer; transition: transform 0.2s; ${greyStyle}" 
             onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)'"
             onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'"
             onclick="window.location.href='/knight.html?id=${knight.id}'">
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
              <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 10px;">
                <h3 style="margin: 0; color: #333;">${knight.name}</h3>
                ${statusBadge}
              </div>
              <p style="margin: 5px 0; color: #666;"><strong>Class:</strong> ${knight.class}</p>
              <p style="margin: 5px 0; color: #666;"><strong>Level:</strong> ${knight.level}</p>
              <p style="margin: 5px 0; color: #666;"><strong>Age:</strong> ${calculateAge(knight.created_at)}</p>
              ${isDead ? '<p style="margin: 5px 0; color: #e74c3c;"><strong>HP:</strong> 0 / ' + knight.max_hp + '</p>' : '<p style="margin: 5px 0; color: #666;"><strong>HP:</strong> ' + knight.current_hp + ' / ' + knight.max_hp + '</p>'}
              ${isDead ? '' : '<p style="margin: 5px 0; color: #666;"><strong>XP:</strong> ' + (knight.exp || 0) + '</p>'}
            </div>
            <div style="color: #667eea; font-size: 24px;">‚Üí</div>
          </div>
        </div>
      `}).join('');
    }

    function calculateAge(created_at) {
      const created = new Date(created_at);
      const now = new Date();
      const days = Math.floor((now - created) / (1000 * 60 * 60 * 24));
      
      if (days === 0) return 'Less than 1 day';
      if (days === 1) return '1 day';
      return `${days} days`;
    }

    function updateCreateButton() {
      const btn = document.getElementById('createKnightBtn');
      const livingKnights = knights.filter(k => k.is_alive);
      const allLevel10 = livingKnights.length > 0 && livingKnights.every(k => k.level >= 10);
      
      if (livingKnights.length > 0 && !allLevel10) {
        btn.disabled = true;
        btn.style.background = '#ccc';
        btn.style.cursor = 'not-allowed';
        btn.textContent = 'All living knights must be level 10 to create a new one';
      } else {
        btn.disabled = false;
        btn.style.background = '#667eea';
        btn.style.cursor = 'pointer';
        btn.textContent = 'Create New Knight';
      }
    }

    function showCreateForm() {
      document.getElementById('createFormContainer').style.display = 'block';
      document.getElementById('message').innerHTML = '';
    }

    function hideCreateForm() {
      document.getElementById('createFormContainer').style.display = 'none';
      document.getElementById('createKnightForm').reset();
    }

    function showMessage(msg, type) {
      const messageDiv = document.getElementById('message');
      messageDiv.innerHTML = `<div style="padding: 10px; border-radius: 5px; text-align: center; background: ${type === 'error' ? '#fee' : '#efe'}; color: ${type === 'error' ? '#c33' : '#3c3'};">${msg}</div>`;
    }

    document.getElementById('createKnightForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const name = document.getElementById('knightName').value;
      const knightClass = document.getElementById('knightClass').value;

      try {
        const response = await fetch('/api/knights', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            user_id: user.user_id,
            name: name,
            class: knightClass
          })
        });
        const data = await response.json();
        
        if (response.ok) {
          showMessage('Knight created successfully!', 'success');
          hideCreateForm();
          loadKnights();
        } else {
          showMessage(data.error || 'Failed to create knight', 'error');
        }
      } catch (error) {
        showMessage('Connection error. Please try again.', 'error');
      }
    });

    async function loadLeaderboard() {
      try {
        const response = await fetch('/api/leaderboard');
        const data = await response.json();
        
        if (response.ok) {
          displayLeaderboard(data);
        }
      } catch (error) {
        document.getElementById('leaderboard').innerHTML = '<p style="text-align: center; color: #999;">Error loading leaderboard</p>';
      }
    }

    function displayLeaderboard(knights) {
      const container = document.getElementById('leaderboard');
      
      if (knights.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: #999;">No knights yet!</p>';
        return;
      }

      container.innerHTML = `
        <div style="display: grid; gap: 10px;">
          ${knights.map((knight, index) => {
            const medal = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : `${index + 1}.`;
            const isCurrentUser = knight.username === user.username;
            const highlightStyle = isCurrentUser ? 'background: #e8f5e9; border-left: 4px solid #27ae60;' : 'background: white;';
            
            return `
              <div style="${highlightStyle} padding: 15px; border-radius: 5px; display: flex; justify-content: space-between; align-items: center;">
                <div style="display: flex; align-items: center; gap: 15px; flex: 1;">
                  <span style="font-size: 20px; font-weight: bold; min-width: 35px;">${medal}</span>
                  <div style="flex: 1;">
                    <div style="font-weight: bold; color: #333;">${knight.name}</div>
                    <div style="font-size: 12px; color: #666;">${knight.class} ‚Ä¢ ${knight.username}</div>
                  </div>
                </div>
                <div style="text-align: right;">
                  <div style="font-weight: bold; color: #667eea;">Level ${knight.level}</div>
                  <div style="font-size: 12px; color: #666;">${knight.exp} XP</div>
                </div>
              </div>
            `;
          }).join('')}
        </div>
      `;
    }

    function showWantedReason(name, reason) {
      alert(`üö® WANTED: ${name.toUpperCase()} üö®\n\n${reason}`);
    }

    // Load data on page load
    loadKnights();
    loadLeaderboard();
  </script>
</body>
</html>
