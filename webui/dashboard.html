<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Knight Club - Dashboard</title>
  <style>
    body {
      font-family: sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      margin: 0;
      padding: 20px;
    }
    .navbar {
      background: white;
      padding: 15px 30px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
    }
    .navbar h1 {
      margin: 0;
      color: #333;
      font-size: 24px;
    }
    .navbar .user-info {
      display: flex;
      gap: 20px;
      align-items: center;
    }
    .navbar .username {
      color: #667eea;
      font-weight: 600;
    }
    .navbar button {
      padding: 8px 20px;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: 600;
    }
    .navbar button:hover {
      background: #5568d3;
    }
    .content {
      background: white;
      padding: 40px;
      border-radius: 10px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.2);
      max-width: 800px;
      margin: 0 auto;
    }
    .welcome {
      text-align: center;
      color: #333;
      margin-bottom: 30px;
    }
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-top: 30px;
    }
    .stat-card {
      background: #f5f7fa;
      padding: 20px;
      border-radius: 8px;
      text-align: center;
    }
    .stat-card h3 {
      margin: 0 0 10px 0;
      color: #667eea;
      font-size: 32px;
    }
    .stat-card p {
      margin: 0;
      color: #666;
    }
  </style>
</head>
<body>
  <div class="navbar">
    <h1>üõ°Ô∏è KNIGHT CLUB</h1>
    <div class="user-info">
      <span class="username" id="username"></span>
      <button onclick="logout()">Logout</button>
    </div>
  </div>

  <div class="content">
    <div class="welcome">
      <h2>Your Knights</h2>
    </div>

    <div id="knightsList"></div>

    <button id="createKnightBtn" onclick="showCreateForm()" style="margin-top: 20px; padding: 12px 30px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: 600; font-size: 16px;">
      Create New Knight
    </button>

    <div id="createFormContainer" style="display: none; margin-top: 30px; padding: 20px; background: #f5f7fa; border-radius: 8px;">
      <h3>Create a New Knight</h3>
      <form id="createKnightForm">
        <div style="margin-bottom: 15px;">
          <label style="display: block; margin-bottom: 5px; color: #555; font-weight: 600;">Name</label>
          <input type="text" id="knightName" required style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 5px; box-sizing: border-box;">
        </div>
        <div style="margin-bottom: 15px;">
          <label style="display: block; margin-bottom: 5px; color: #555; font-weight: 600;">Class</label>
          <select id="knightClass" required style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 5px; box-sizing: border-box;">
            <option value="knight">Knight</option>
            <option value="paladin">Paladin</option>
            <option value="lancer">Lancer</option>
            <option value="templar">Templar</option>
          </select>
        </div>
        <div style="display: flex; gap: 10px;">
          <button type="submit" style="flex: 1; padding: 12px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: 600;">Create</button>
          <button type="button" onclick="hideCreateForm()" style="flex: 1; padding: 12px; background: #ccc; color: #333; border: none; border-radius: 5px; cursor: pointer; font-weight: 600;">Cancel</button>
        </div>
      </form>
    </div>

    <div id="message" style="margin-top: 20px;"></div>
  </div>

  <script>
    // Check if user is logged in
    const user = JSON.parse(localStorage.getItem('knightclub_user') || 'null');
    if (!user) {
      window.location.href = '/';
    }

    // Display username
    document.getElementById('username').textContent = user.username;

    let knights = [];

    function logout() {
      localStorage.removeItem('knightclub_user');
      window.location.href = '/';
    }

    async function loadKnights() {
      try {
        const response = await fetch(`/api/knights?user_id=${user.user_id}`);
        const data = await response.json();
        
        if (response.ok) {
          knights = data.knights || [];
          displayKnights();
          updateCreateButton();
        }
      } catch (error) {
        showMessage('Error loading knights', 'error');
      }
    }

    function displayKnights() {
      const container = document.getElementById('knightsList');
      
      if (knights.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">No knights yet. Create your first knight!</p>';
        return;
      }

      container.innerHTML = knights.map(knight => `
        <div style="background: #f5f7fa; padding: 20px; border-radius: 8px; margin-bottom: 15px; cursor: pointer; transition: transform 0.2s;" 
             onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)'"
             onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'"
             onclick="window.location.href='/knight.html?id=${knight.id}'">
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
              <h3 style="margin: 0 0 10px 0; color: #333;">${knight.name}</h3>
              <p style="margin: 5px 0; color: #666;"><strong>Class:</strong> ${knight.class}</p>
              <p style="margin: 5px 0; color: #666;"><strong>Level:</strong> ${knight.level}</p>
              <p style="margin: 5px 0; color: #666;"><strong>Age:</strong> ${calculateAge(knight.created_at)}</p>
            </div>
            <div style="color: #667eea; font-size: 24px;">‚Üí</div>
          </div>
        </div>
      `).join('');
    }

    function calculateAge(created_at) {
      const created = new Date(created_at);
      const now = new Date();
      const days = Math.floor((now - created) / (1000 * 60 * 60 * 24));
      
      if (days === 0) return 'Less than 1 day';
      if (days === 1) return '1 day';
      return `${days} days`;
    }

    function updateCreateButton() {
      const btn = document.getElementById('createKnightBtn');
      const allLevel10 = knights.length > 0 && knights.every(k => k.level >= 10);
      
      if (knights.length > 0 && !allLevel10) {
        btn.disabled = true;
        btn.style.background = '#ccc';
        btn.style.cursor = 'not-allowed';
        btn.textContent = 'All knights must be level 10 to create a new one';
      } else {
        btn.disabled = false;
        btn.style.background = '#667eea';
        btn.style.cursor = 'pointer';
        btn.textContent = 'Create New Knight';
      }
    }

    function showCreateForm() {
      document.getElementById('createFormContainer').style.display = 'block';
      document.getElementById('message').innerHTML = '';
    }

    function hideCreateForm() {
      document.getElementById('createFormContainer').style.display = 'none';
      document.getElementById('createKnightForm').reset();
    }

    function showMessage(msg, type) {
      const messageDiv = document.getElementById('message');
      messageDiv.innerHTML = `<div style="padding: 10px; border-radius: 5px; text-align: center; background: ${type === 'error' ? '#fee' : '#efe'}; color: ${type === 'error' ? '#c33' : '#3c3'};">${msg}</div>`;
    }

    document.getElementById('createKnightForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const name = document.getElementById('knightName').value;
      const knightClass = document.getElementById('knightClass').value;

      try {
        const response = await fetch('/api/knights', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            user_id: user.user_id,
            name: name,
            class: knightClass
          })
        });
        const data = await response.json();
        
        if (response.ok) {
          showMessage('Knight created successfully!', 'success');
          hideCreateForm();
          loadKnights();
        } else {
          showMessage(data.error || 'Failed to create knight', 'error');
        }
      } catch (error) {
        showMessage('Connection error. Please try again.', 'error');
      }
    });

    // Load knights on page load
    loadKnights();
  </script>
</body>
</html>
